@page "/"
@attribute [StreamRendering]
@rendermode InteractiveServer

@using System.Globalization
@using ARM.Dolar.Guru.BaseBlazor.Models
@using ARM.Dolar.Guru.Models
@using ARM.Dolar.Guru.Services
@inject CotizacionesService CotizacionesService

<PageTitle>Home</PageTitle>

<style>
    .card-hover {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card-hover:hover {
        transform: scale(1.03);
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.3);
    }
</style>

<div class="w-100 py-3 mb-4 bg-light border-bottom shadow-sm rounded px-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <h5 class="mb-2 mb-md-0 text-primary fw-bold">📈 Cotizaciones actualizadas al instante</h5>

        <button class="btn btn-outline-primary fw-semibold shadow-sm px-4 py-2 rounded-pill d-flex align-items-center gap-2"
                @onclick="RecargarCotizaciones"
                disabled="@cargando">
            @if (cargando)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span>Cargando...</span>
            }
            else
            {
                <span>🔄 Recargar cotizaciones</span>
            }
        </button>
    </div>
</div>

@if (cotizacionesDolar is null || cotizacionesOtros is null)
{
    <div class="text-center py-5">
        <img src="dolar-guru.png" style="max-height: 332px;" />
        <div class="spinner-border text-primary mt-3" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
}
else
{
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white fw-bold fs-5">
            💵 Cotizaciones del Dólar
        </div>
        <div class="card-body">
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                @foreach (var cotizacion in cotizacionesDolar)
                {
                    var tipo = TipoDolarHelper.Parse(cotizacion.Nombre);
                    var estilo = Estilos.Dolar[tipo];
                    var icono = Estilos.IconosDolar.ContainsKey(tipo) ? Estilos.IconosDolar[tipo] : "bi-cash-coin";
                    var horas = (int)(DateTime.UtcNow - cotizacion.FechaActualizacion.ToUniversalTime()).TotalHours;

                    <div class="col">
                        <div class="card h-100 text-white border-0 shadow-lg card-hover"
                             style="background: linear-gradient(135deg, @estilo.Color1, @estilo.Color2);">
                            <div class="card-body d-flex flex-column justify-content-between">
                                <div class="mb-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h5 class="card-title fw-bold mb-0">
                                            <i class="bi @icono me-2 fs-4"></i>@cotizacion.Nombre
                                        </h5>
                                        <span class="badge bg-light text-dark">ARS/USD</span>
                                    </div>
                                    <p class="mt-2"><i class="bi bi-clock-history me-1"></i>Hace @horas horas</p>
                                </div>
                                <div class="d-flex justify-content-around border-top pt-3 mt-auto">
                                    <div class="text-center">
                                        <i class="bi bi-arrow-down-circle-fill fs-4 mb-1"></i><br />
                                        <small class="fw-light">Compra</small><br />
                                        <span class="fs-5 fw-bold">$@cotizacion.Compra</span>
                                    </div>
                                    <div class="text-center">
                                        <i class="bi bi-arrow-up-circle-fill fs-4 mb-1"></i><br />
                                        <small class="fw-light">Venta</small><br />
                                        <span class="fs-5 fw-bold">$@cotizacion.Venta</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white fw-bold fs-5">
            💵 Otras Cotizaciones
            <small class="ms-2 text-light">Valores expresados en relación al <strong>Peso Argentino</strong></small>
        </div>
        <div class="card-body">
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                @foreach (var cotizacion in cotizacionesOtros)
                {
                    var tipo = TipoDivisaHelper.Parse(cotizacion.Nombre);
                    var estilo = Estilos.Otros[tipo];
                    var icono = Estilos.IconosOtros.ContainsKey(tipo) ? Estilos.IconosOtros[tipo] : "bi-cash-coin";
                    var horas = (int)(DateTime.UtcNow - cotizacion.FechaActualizacion.ToUniversalTime()).TotalHours;

                    <div class="col">
                        <div class="card h-100 text-white border-0 shadow-lg card-hover"
                             style="background: linear-gradient(135deg, @estilo.Color1, @estilo.Color2);">
                            <div class="card-body d-flex flex-column justify-content-between">
                                <div class="mb-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h5 class="card-title fw-bold mb-0">
                                            <i class="bi @icono me-2 fs-4"></i>@cotizacion.Nombre
                                        </h5>
                                        <span class="badge bg-light text-dark">@cotizacion.Moneda / ARS</span>
                                    </div>
                                    <p class="mt-2"><i class="bi bi-clock-history me-1"></i>Hace @horas horas</p>
                                </div>
                                <div class="d-flex justify-content-around border-top pt-3 mt-auto">
                                    <div class="text-center">
                                        <i class="bi bi-arrow-down-circle-fill fs-4 mb-1"></i><br />
                                        <small class="fw-light">Compra</small><br />
                                        <span class="fs-5 fw-bold">$@cotizacion.Compra</span>
                                    </div>
                                    <div class="text-center">
                                        <i class="bi bi-arrow-up-circle-fill fs-4 mb-1"></i><br />
                                        <small class="fw-light">Venta</small><br />
                                        <span class="fs-5 fw-bold">$@cotizacion.Venta</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

<Disclaimer />

@code {
    private bool cargando = false;
    List<Cotizacion>? cotizacionesDolar;
    List<CotizacionOtros>? cotizacionesOtros;

    protected override async Task OnInitializedAsync()
    {
        await RecargarCotizaciones();
    }

    private async Task RecargarCotizaciones()
    {
        cargando = true;
        (cotizacionesDolar, cotizacionesOtros) = await CotizacionesService.ObtenerUltimasCotizacionesAsync();
        cargando = false;
    }
}